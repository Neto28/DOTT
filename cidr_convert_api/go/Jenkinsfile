pipeline {
  agent any
  stages {
    stage('Build') {
      steps {
        echo 'BUILDING'
        warnError(message: 'Container already running') {
          dir(path: 'cidr_convert_api/go/') {
            sh 'containerID=$(docker ps -aqf "name=goimage")'
            sh 'docker run -d --name goimage -ti -p 8000:8000 gom'
          }

        }

      }
    }

    stage('SonarCloud') {
      steps {
        script {
          echo 'SONARCLOUD STATIC CODE ANALYSIS'
          dir(path: 'cidr_convert_api/go/') {
            sh'pwd'
            sh 'ls'
            sh 'docker exec -i $(docker ps -aqf "name=goimage") go test -coverprofile=coverage.out'
          }
          warnError(message: 'Jenkins SonarQube Failure') {
            def scannerHome = tool 'My SonarQube Server';
            withSonarQubeEnv("My SonarQube Server") {
              sh "${tool("My SonarQube Server")}/bin/sonar-scanner \
              -Dsonar.organization=$ORG \
              -Dsonar.projectKey=$KEY \
              -Dsonar.sources=. \
              -Dsonar.login=$TOKEN \
              -Dsonar.go.tests.reportPaths=$WORKSPACE/coverage.out \
              -Dsonar.host.url=https://sonarcloud.io"
            }
          }
        }

      }
    }

    stage('Testing') {
      steps {
        warnError(message: 'Failed to Run Tests') {
          sh 'go version'
          dir(path: 'cidr_convert_api/go/') {
            sh 'docker exec -i $(docker ps -aqf "name=goimage") go test'
          }

        }

      }
    }

    stage('Deploy') {
      steps {
        echo 'DEPLOYING'
        warnError(message: 'Container doesn\'t exist') {
          sh '''echo "DESTORING EXISTING GO CONTAINER"
docker rm -f $(docker ps -aqf "name=goimage")
'''
        }

      }
    }

  }
  environment {
    ORG = credentials('org')
    HOST = credentials('host')
    KEY = credentials('key')
    TOKEN = credentials('token')
  }
}
