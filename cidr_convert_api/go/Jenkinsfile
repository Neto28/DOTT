pipeline {
  agent any
  stages {
    stage('Build') {
      steps {
        echo 'BUILDING'
        warnError(message: 'Container already running') {
          dir(path: 'cidr_convert_api/go/') {
            sh 'containerID=$(sudo docker ps -aqf "name=goimage")'
            sh 'sudo docker run -d --name goimage -ti -p 8000:8000 gom'
          }

        }

        dir(path: '/var/lib/jenkins/workspace') {
          sh './sonarcloud.sh'
        }

      }
    }

    stage('SonarCloud') {
      steps {
        sh '''echo \'SONARCLOUD STATIC CODE ANALYSIS\'

sonar-scanner'''
      }
    }

    stage('Testing') {
      steps {
        warnError(message: 'Failed to Run') {
          sh 'go version'
          dir(path: 'cidr_convert_api/go/') {
            sh 'sudo docker exec -i $(sudo docker ps -aqf "name=goimage") go test'
          }

        }

      }
    }

    stage('Deploy') {
      steps {
        echo 'Test'
        sh '''echo "DESTORING EXISTING GO CONTAINER"
sudo docker rm -f $(sudo docker ps -aqf "name=goimage")
'''
      }
    }

  }
}